// vite.config.js
import { defineConfig } from "vite"
import { resolve } from "path"
import { readFileSync, writeFileSync } from "fs"

function fixBackticks(content) {
  return content.replace(/`/g, "\` + \"\`\" + \`")
}

export default defineConfig({
  build: {
    sourcemap: "inline",
    outDir: "dist",
    rollupOptions: {
      input: "main.ts",
      output: {
        entryFileNames: "main.js",
        assetFileNames: "[name].[ext]",
      }
    }
  },
  plugins:[
    {
      name: "copy-client-bundle",
      closeBundle: async () => {
        const indexContent = fixBackticks(readFileSync(resolve(__dirname, "index.html"), "utf-8"))
        const scriptContent = fixBackticks(readFileSync(resolve(__dirname, "dist/main.js"), "utf-8"))
        const stylesheetContent = fixBackticks(readFileSync(resolve(__dirname, "dist/main.css"), "utf-8"))
        const bundleContent = `
// Code generated by vite from client-bundle DO NOT EDIT.
package webui

var index = []byte(\`${indexContent}\`)

var script = []byte(\`${scriptContent}\`)

var stylesheet = []byte(\`${stylesheetContent}\`)
`
        writeFileSync(resolve(__dirname, "../internal/webui/static.go"), bundleContent)
      }
    }
  ]
})